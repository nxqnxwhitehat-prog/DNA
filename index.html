<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ (DNA)</title>
<style>
/* ----- Ø¹Ø§Ù… ----- */
:root{--blue:#007bff;--dark:#003f7f;--muted:#ff9800;--danger:#ff5252}
*{box-sizing:border-box}
body {
  margin:0; font-family: Arial, sans-serif;
  background:#e8f6ff; direction: rtl; text-align: right;
  -webkit-font-smoothing:antialiased;
}

/* ----- Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ ----- */
#lockScreen {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:radial-gradient(circle at center, #001d3d 0%, #000814 100%);
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  z-index:4000; overflow:hidden; color:white; text-align:center;
}
#lockScreen::before {
  content:''; position:absolute; top:0; left:0; width:100%; height:100%;
  background:url('Democratic Negotiation Agency Emblem.png') center/280px no-repeat;
  opacity:0.08; filter:blur(3px);
}
#lockBox {
  position:relative; z-index:10; background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12); border-radius:14px;
  padding:34px 26px; text-align:center; backdrop-filter:blur(6px);
  box-shadow:0 6px 30px rgba(0,0,0,0.45); color:#fff; width:92%; max-width:380px;
}
#lockBox h2{margin:0 0 14px 0}
#lockBox input {
  padding:12px; width:80%; border-radius:10px; border:none;
  text-align:center; font-size:16px; margin-bottom:12px; outline:none;
}
#lockBox button {
  padding:10px 22px; background:var(--blue); color:white; border:none;
  border-radius:8px; cursor:pointer; font-size:15px;
}
#lockBox button:hover{background:var(--dark)}
#lockError {color:#ff6b6b; display:none; margin-top:10px; font-weight:700}

/* ----- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ (splash) ----- */
#splash {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:#f8f8f8; display:flex; justify-content:center; align-items:center;
  z-index:3000; opacity:1; transition:opacity .8s ease;
}
#splash img { width:300px; max-width:80%; }

/* ----- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ ----- */
.navbar {
  position:fixed; top:0; right:0; width:100%;
  background:var(--blue); display:flex; flex-direction:row-reverse;
  justify-content:flex-start; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.12);
  z-index:1000;
}
.navbar button {
  background:#fff; color:var(--blue); border:none;
  padding:10px 18px; margin-left:10px; border-radius:8px; cursor:pointer;
}
.navbar button.active { background:var(--dark); color:#fff; font-weight:bold; box-shadow:0 0 8px rgba(0,0,0,0.18); }

/* ----- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© ----- */
.fixed-image {
  position:fixed; top:70px; left:10px; width:110px; border-radius:8px; z-index:999;
}
.content { padding:100px 20px; max-width:1000px; margin:0 auto; }
.section { display:none; }
.section.active { display:block; animation:fadeIn .25s ease; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.box {
  background:#fff; padding:18px; border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08); max-width:760px; margin:auto;
}
input, select, button {
  width:100%; padding:10px; margin:10px 0; border-radius:8px;
  border:1px solid #ccc; font-size:15px; box-sizing:border-box;
}
.user-list {
  background:#fff; padding:12px; border-radius:8px;
  box-shadow:0 1px 5px rgba(0,0,0,0.05); max-width:820px; margin:auto;
}
table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
th, td { padding:10px; border-bottom:1px solid #eee; text-align:center; }
th { background:var(--blue); color:#fff; }
.chat-box {
  max-width:760px; margin:auto; background:#fff; padding:12px;
  border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08);
  display:flex; flex-direction:column; height:420px;
}
.messages {
  flex:1; overflow-y:auto; padding:10px; border:1px solid #eee; border-radius:8px;
  background:#fafafa; margin-bottom:10px;
}
.message { background:#dff1ff; padding:8px 10px; border-radius:8px; margin:6px 0; }
.message .meta { font-weight:bold; color:#034a7f; margin-bottom:4px; }
.small { font-size:13px; color:#666; }
.center { text-align:center; }
.delete-btn, .mute-btn, .clear-btn { background:var(--danger); color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
.mute-btn { background:var(--muted); }
.clear-btn { background:var(--blue); }
.hidden { display:none; }

/* responsive */
@media (max-width:600px){
  #lockBox{padding:24px}
  .fixed-image{display:none}
  .chat-box{height:360px}
}
</style>
</head>

<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ (Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
<div id="lockScreen">
  <div id="lockBox">
    <h2>ğŸ”’ Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹</h2>
    <input type="password" id="accessCode" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„">
    <br>
    <button id="lockBtn">Ø¯Ø®ÙˆÙ„</button>
    <p id="lockError">Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ âŒ</p>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ (ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ù‚ÙÙ„) -->
<div id="splash" class="hidden">
  <img src="Democratic Negotiation Agency Emblem.png" alt="DNA Logo">
</div>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ù…Ø®ÙÙŠ Ø­ØªÙ‰ Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„Ù‚ÙÙ„ + Ø§Ù„Ø³Ù„Ø§Ø´) -->
<div id="mainApp" class="hidden">
  <div class="navbar">
    <button onclick="showSection('home')" class="active">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button onclick="showSection('about')">Ø­ÙˆÙ„</button>
    <button onclick="showSection('dna')">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
    <button onclick="showSection('users')" id="membersBtn">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>
    <button onclick="showSection('chat')" id="chatBtn" class="hidden">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
  </div>

  <img src="DNA.png" alt="logo" class="fixed-image" onerror="this.style.display='none'">

  <div class="content">
    <div id="home" class="section active">
      <div class="box">
        <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§</h2>
        <p class="small">Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ®Ø²Ù† Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ (localStorage) Ø­ØªÙ‰ Ù„Ø§ ØªÙØ­Ø°Ù Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„.</p>
        <p class="small">Ø§Ù„ÙˆÙƒÙŠÙ„ ÙŠÙ…ØªÙ„Ùƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø­Ø°Ù/Ù…Ù†Ø¹/Ù…Ø³Ø­ Ø¯Ø±Ø¯Ø´Ø©).</p>
      </div>
    </div>

    <div id="about" class="section">
      <div class="box">
        <h2>Ø¹Ù† Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
        <p class="small">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø³ÙŠØ·: ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ø¬Ù„ Ø§Ø³Ù… ÙˆØ¹Ù…Ø± ÙˆÙŠØ®ØªØ§Ø± Ø§Ù„Ø¯ÙˆØ± (Ø¹Ø¶Ùˆ Ø£Ùˆ ÙˆÙƒÙŠÙ„). ÙÙ‚Ø· ÙˆÙƒÙŠÙ„ ÙˆØ§Ø­Ø¯ Ù…Ø³Ù…ÙˆØ­.</p>
      </div>
    </div>

    <div id="dna" class="section">
      <div id="rulesBox" class="box">
        <h3>ğŸ“œ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ÙˆØ§Ù„Ø´Ø±ÙˆØ·</h3>
        <ul>
          <li>Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ø¬Ø¨.</li>
          <li>Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø£ÙƒØ«Ø± Ù…Ù† ÙˆÙƒÙŠÙ„ ÙˆØ§Ø­Ø¯.</li>
          <li>ÙŠØ¬Ø¨ Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø³Ù…Ø§Ø¡ Ù…Ø²ÙŠÙØ©.</li>
        </ul>
        <div class="center"><button onclick="agreeRules()">Ø£ÙˆØ§ÙÙ‚ ÙˆØ£ÙƒÙ…Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button></div>
      </div>

      <form id="voteForm" class="box hidden">
        <h3>Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
        <label>Ø§Ù„Ø§Ø³Ù…:</label>
        <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
        <label>Ø§Ù„Ø¹Ù…Ø±:</label>
        <input type="number" id="age" placeholder="Ø§Ù„Ø¹Ù…Ø±" required min="1">
        <label>Ø§Ù„Ø¯ÙˆØ±:</label>
        <select id="role" required>
          <option value="">Ø§Ø®ØªØ±...</option>
          <option value="ÙˆÙƒÙŠÙ„">ÙˆÙƒÙŠÙ„</option>
          <option value="Ø¹Ø¶Ùˆ">Ø¹Ø¶Ùˆ</option>
        </select>
        <button type="submit">ØªØ³Ø¬ÙŠÙ„</button>
      </form>

      <div id="welcomeBox" class="box hidden">
        <h3 id="welcomeTitle"></h3>
        <p class="small">ØªÙ… Ø­ÙØ¸ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ù„ÙŠÙ‹Ø§. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØµÙØ­Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©).</p>
      </div>
    </div>

    <div id="users" class="section">
      <h2 class="center">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h2>
      <div id="userList" class="user-list box"></div>
    </div>

    <div id="chat" class="section">
      <h2 class="center">Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2>
      <div class="chat-box">
        <div id="agentTools" class="hidden center" style="margin-bottom:8px;">
          <button class="clear-btn" onclick="clearChat()">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
        </div>
        <div id="messages" class="messages"></div>
        <input id="chatInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ø«Ù… Ø§Ø¶ØºØ· Enter" onkeydown="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† ===== */
const USERS_KEY = 'users';
const CURRENT_KEY = 'currentUser';
const MESSAGES_KEY = 'messages';
const ACCESS_KEY = 'accessUnlocked'; // Ù„ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
let users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
let currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY)) || null;
let messages = JSON.parse(localStorage.getItem(MESSAGES_KEY)) || [];

/* ===== Ø¹Ù†Ø§ØµØ± DOM ===== */
const lockScreen = document.getElementById('lockScreen');
const lockBtn = document.getElementById('lockBtn');
const lockError = document.getElementById('lockError');
const splash = document.getElementById('splash');
const mainApp = document.getElementById('mainApp');
const chatBtn = document.getElementById('chatBtn');

/* ===== ØªØ­Ù‚Ù‚ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ (123456789) ===== */
function unlockFlow() {
  // Ø¥Ø°Ø§ Ù…Ø­ØªØ±Ù: ÙŠÙ…ÙƒÙ†Ùƒ Ø­ÙØ¸ Ù…ÙØªØ§Ø­ ACCESS_KEY Ù„ÙŠØ¨Ù‚Ù‰ Ù…ÙØªÙˆØ­Ù‹Ø§ØŒ Ù‡Ù†Ø§ Ù„Ø§ Ù†Ø­ÙØ¸Ù‡ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
  // Ø§ÙØ­Øµ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ACCESS_KEY Ù…Ø­ÙÙˆØ¸Ù‹Ø§ Ù„ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù‚ÙÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  const unlocked = sessionStorage.getItem(ACCESS_KEY) === '1';
  if (unlocked) {
    startSplashAndShowApp();
  } else {
    lockScreen.style.display = 'flex';
  }
}

lockBtn.addEventListener('click', () => {
  const val = document.getElementById('accessCode').value.trim();
  if (val === '123456789') {
    // Ø§Ø­ÙØ¸ ÙÙŠ sessionStorage Ù„ÙŠØ¨Ù‚Ù‰ Ù…ÙØªÙˆØ­ Ø®Ù„Ø§Ù„ Ø§Ù„Ø¬Ù„Ø³Ø© (ØªØ³ØªØ·ÙŠØ¹ ØªØºÙŠÙŠØ±Ù‡)
    sessionStorage.setItem(ACCESS_KEY, '1');
    lockScreen.style.display = 'none';
    startSplashAndShowApp();
  } else {
    lockError.style.display = 'block';
  }
});

/* ===== Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø«Ù… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ===== */
function startSplashAndShowApp(){
  splash.classList.remove('hidden');
  // Ù†Ø¸Ù Ø£ÙŠ Ø¹Ø±Ø¶ Ø³Ø§Ø¨Ù‚
  setTimeout(()=>{
    splash.style.opacity = '0';
    setTimeout(()=>{
      splash.style.display = 'none';
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
      mainApp.classList.remove('hidden');
      // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø©
      loadState();
      updateChatButton();
      if (currentUser) showWelcome(currentUser);
      // ØªÙ†Ø¨ÙŠÙ‡ ØªØ±Ø­ÙŠØ¨ÙŠ
      alert('ğŸ–ï¸ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ ÙˆÙƒØ§Ù„Ø© Ø§Ù„Ù…ÙØ§ÙˆØ¶Ø§Øª Ø§Ù„Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠØ© (DNA)');
    },800);
  },2000);
}

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† ===== */
function loadState(){
  users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY)) || null;
  messages = JSON.parse(localStorage.getItem(MESSAGES_KEY)) || [];
}

/* ===== Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ===== */
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
  document.querySelectorAll('.navbar button').forEach(b => b.classList.remove('active'));
  const match = Array.from(document.querySelectorAll('.navbar button')).find(b => (b.getAttribute('onclick')||'').includes(`'${id}'`));
  if (match) match.classList.add('active');

  if (id === 'users') {
    // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† localStorage Ø¹Ù†Ø¯ ÙƒÙ„ ÙØªØ­
    users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
    renderUsers();
  }
  if (id === 'chat') renderChat();
}

/* ===== Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ â†’ Ù†Ù…ÙˆØ°Ø¬ â†’ ØªØ³Ø¬ÙŠÙ„) ===== */
function agreeRules(){
  document.getElementById('rulesBox').classList.add('hidden');
  document.getElementById('voteForm').classList.remove('hidden');
}

document.getElementById('voteForm').addEventListener('submit', function(e){
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const role = document.getElementById('role').value;
  if (!name || !age || !role) { alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.'); return; }
  if (role === 'ÙˆÙƒÙŠÙ„' && users.some(u => u.role === 'ÙˆÙƒÙŠÙ„')) { alert('âš ï¸ Ù‡Ù†Ø§Ùƒ ÙˆÙƒÙŠÙ„ Ø¨Ø§Ù„ÙØ¹Ù„.'); return; }
  if (users.some(u => u.name === name)) { alert('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§.'); return; }
  const newUser = { name, age, role, muted:false, createdAt: new Date().toISOString() };
  users.push(newUser);
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  currentUser = newUser;
  localStorage.setItem(CURRENT_KEY, JSON.stringify(currentUser));
  // Ø§Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆÙƒÙŠÙ„ (Ù…Ø­Ù„ÙŠ) â€” Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ø¹Ø¨Ø± Ø­Ø¯Ø« Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø£ÙŠØ¶Ù‹Ø§ Ù„Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¨ÙˆÙŠØ¨ Ø£Ø®Ø±Ù‰
  notifyAgentNewUser(newUser);
  showWelcome(newUser);
  updateChatButton();
  alert('âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.');
  this.reset();
});

/* ===== Ø¥Ø¸Ù‡Ø§Ø± ØªØ±Ø­ÙŠØ¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ===== */
function showWelcome(user){
  document.getElementById('voteForm').classList.add('hidden');
  document.getElementById('rulesBox').classList.add('hidden');
  const w = document.getElementById('welcomeBox');
  w.classList.remove('hidden');
  document.getElementById('welcomeTitle').innerText = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ${user.name} â€” Ø£Ù†Øª ${user.role}`;
}

/* ===== Ø²Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø±Ø¦ÙŠ ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
function updateChatButton(){
  const btn = document.getElementById('chatBtn');
  if (currentUser) btn.classList.remove('hidden'); else btn.classList.add('hidden');
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ø²Ø± Ø­Ø°Ù/Ù…Ù†Ø¹ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„ÙˆÙƒÙŠÙ„) ===== */
function renderUsers(){
  const el = document.getElementById('userList');
  users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  if (users.length === 0) { el.innerHTML = '<p class="center small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡.</p>'; return; }
  const isAgent = currentUser && currentUser.role === 'ÙˆÙƒÙŠÙ„';
  let html = `<table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¹Ù…Ø±</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>${isAgent?'<th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>':''}</tr></thead><tbody>`;
  users.forEach((u,i)=>{
    html += `<tr>
      <td>${escapeHtml(u.name)}</td>
      <td>${escapeHtml(u.age)}</td>
      <td>${escapeHtml(u.role)}</td>
      <td class="small">${new Date(u.createdAt).toLocaleString()}</td>
      ${isAgent?`<td>${u.name!== (currentUser?.name||'') ? `<button class="mute-btn" onclick="toggleMute(${i})">${u.muted? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ù†Ø¹' : 'Ù…Ù†Ø¹ Ù…Ù† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©'}</button> <button class="delete-btn" onclick="deleteUser(${i})">Ø­Ø°Ù</button>` : '-'}</td>` : ''}
    </tr>`;
  });
  html += `</tbody></table>`;
  el.innerHTML = html;
}

/* ===== Ø­Ø¸Ø±/Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø¹Ø¶Ùˆ ===== */
function toggleMute(index){
  // ØªØ­Ù‚Ù‚ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆÙƒÙŠÙ„
  if (!currentUser || currentUser.role !== 'ÙˆÙƒÙŠÙ„') { alert('âŒ ÙÙ‚Ø· Ø§Ù„ÙˆÙƒÙŠÙ„ ÙŠÙ…ÙƒÙ†Ù‡ Ù…Ù†Ø¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡.'); return; }
  users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  users[index].muted = !users[index].muted;
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  renderUsers();
  alert(users[index].muted ? 'ğŸš« ØªÙ… Ù…Ù†Ø¹ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©' : 'âœ… ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù‡ Ù…Ø¬Ø¯Ø¯Ù‹Ø§');
}

/* ===== Ø­Ø°Ù Ø¹Ø¶Ùˆ (ÙˆÙƒÙŠÙ„ ÙÙ‚Ø·) ===== */
function deleteUser(index){
  if (!currentUser || currentUser.role !== 'ÙˆÙƒÙŠÙ„') return alert('âŒ ÙÙ‚Ø· Ø§Ù„ÙˆÙƒÙŠÙ„ ÙŠÙ…ÙƒÙ†Ù‡ Ø­Ø°Ù Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡.');
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ')) return;
  users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  const removed = users.splice(index,1)[0];
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  // Ø¥Ø°Ø§ Ø­Ø°Ù Ø§Ù„ÙˆÙƒÙŠÙ„ Ù†ÙØ³Ù‡ (ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹) Ø£Ø²Ù„ currentUser
  if (currentUser && currentUser.name === removed.name) {
    localStorage.removeItem(CURRENT_KEY);
    currentUser = null;
    updateChatButton();
  }
  renderUsers();
  alert('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ.');
}

/* ===== Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©: Ø¥Ø±Ø³Ø§Ù„/Ø¹Ø±Ø¶ ÙˆØ±Ø³Ø§Ø¦Ù„ Ù…Ø­ÙÙˆØ¸Ø© ===== */
function sendMessage(){
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  if (!currentUser) { alert('ÙŠØ¬Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.'); return; }
  // Ù…Ù†Ø¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù…Ù†ÙˆØ¹Ù‹Ø§
  // ÙˆÙ„ÙƒÙ†Ù‡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ‚Ø±Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† users array Ù„Ø£Ù† currentUser Ù‚Ø¯ÙŠÙ…
  const latestUsers = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  const me = latestUsers.find(u=>u.name === currentUser.name) || currentUser;
  if (me.muted) return alert('ğŸš« ØªÙ… Ù…Ù†Ø¹Ùƒ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.');
  const msg = { user: me.name, role: me.role, text, time: new Date().toISOString() };
  messages.push(msg);
  localStorage.setItem(MESSAGES_KEY, JSON.stringify(messages));
  input.value = '';
  renderMessages();
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ===== */
function renderMessages(){
  const box = document.getElementById('messages');
  messages = JSON.parse(localStorage.getItem(MESSAGES_KEY)) || [];
  if (messages.length === 0) { box.innerHTML = '<p class="small center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯.</p>'; return; }
  box.innerHTML = messages.map(m=>{
    const mark = m.role === 'ÙˆÙƒÙŠÙ„' ? ' (ÙˆÙƒÙŠÙ„)' : '';
    return `<div class="message"><div class="meta">${escapeHtml(m.user)}${mark} <span class="small">â€” ${new Date(m.time).toLocaleString()}</span></div><div>${escapeHtml(m.text)}</div></div>`;
  }).join('');
  box.scrollTop = box.scrollHeight;
}

/* ===== Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙ‚Ø· Ù„Ù‡ ===== */
/* ===== Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ù…Ø±Ø¦ÙŠØ© Ù„Ù„Ø¬Ù…ÙŠØ¹) ===== */
function renderChat(){
  const tools = document.getElementById('agentTools');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.querySelector('.chat-box button');

  // Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙ‚Ø· ÙŠØ±Ù‰ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
  if (currentUser && currentUser.role === 'ÙˆÙƒÙŠÙ„') {
    tools.classList.remove('hidden');
  } else {
    tools.classList.add('hidden');
  }

  // Ø£ÙŠ Ø´Ø®Øµ ÙŠÙ…ÙƒÙ†Ù‡ Ø±Ø¤ÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  renderMessages();

  // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†
  if (!currentUser) {
    chatInput.disabled = true;
    chatInput.placeholder = "ğŸ“¢ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¹Ø§Ù…Ø© â€” Ø³Ø¬Ù‘Ù„ Ù„ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©";
    sendBtn.disabled = true;
    sendBtn.style.opacity = "0.6";
    sendBtn.style.cursor = "not-allowed";
  } else {
    chatInput.disabled = false;
    chatInput.placeholder = "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ø«Ù… Ø§Ø¶ØºØ· Enter";
    sendBtn.disabled = false;
    sendBtn.style.opacity = "1";
    sendBtn.style.cursor = "pointer";
  }
}

/* ===== Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (ÙˆÙƒÙŠÙ„ ÙÙ‚Ø·) ===== */
function clearChat(){
  if (!currentUser || currentUser.role !== 'ÙˆÙƒÙŠÙ„') return alert('âŒ ÙÙ‚Ø· Ø§Ù„ÙˆÙƒÙŠÙ„ ÙŠÙ…ÙƒÙ†Ù‡ Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.');
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ')) return;
  messages = [];
  localStorage.setItem(MESSAGES_KEY, JSON.stringify(messages));
  renderMessages();
  alert('ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ù†Ø¬Ø§Ø­.');
}

/* ===== Ø¯Ø§Ù„Ø© ØªØ¹Ù‚ÙŠÙ… Ø§Ù„Ù†Øµ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ ÙÙŠ HTML ===== */
function escapeHtml(str){ return String(str || '').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

/* ===== Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ (Ù…Ø­Ù„ÙŠ ÙˆØªØ¨ÙˆÙŠØ¨ÙŠ) ===== */
function notifyAgentNewUser(newUser){
  // Ø¥Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ Ù…Ø³Ø¬Ù„ Ø­Ø§Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¨ ÙˆØ£Ù†Øª Ù„Ø³Øª Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø°ÙŠ Ø³Ø¬Ù„ (Ø£Ùˆ Ø­ØªÙ‰ Ù„Ùˆ Ù‡Ùˆ)ØŒ Ù†Ø¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡
  // Ø³Ù†Ø±Ø§Ù‚Ø¨ Ø£ÙŠØ¶Ø§Ù‹ Ø¹Ø¨Ø± Ø­Ø¯Ø« storage Ù„Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰.
  if (currentUser && currentUser.role === 'ÙˆÙƒÙŠÙ„' && currentUser.name !== newUser.name) {
    alert(`ğŸ”” Ø§Ù†Ø¶Ù… Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯: ${newUser.name} â€” ${newUser.role}`);
  }
  // Ø­Ø¯Ø« Ø§Ù„ØªØ®Ø²ÙŠÙ† (localStorage) Ø³ÙŠØ®Ø¨Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ù„Ø£Ù†Ù†Ø§ Ø­ÙØ¸Ù†Ø§ users Ø¨Ø§Ù„ÙØ¹Ù„.
}

/* ===== Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙ‘Ø± localStorage Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ===== */
window.addEventListener('storage', (e) => {
  if (e.key === USERS_KEY) {
    // ØªÙ… ØªØºÙŠÙŠØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø±
    // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ø¯ÙŠÙ†Ø§
    users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
    // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„ÙˆÙƒÙŠÙ„ØŒ ÙˆÙ†Ø´Ø§Ù‡Ø¯ Ø£Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ø²Ø¯Ø§Ø¯ØŒ Ù†Ù†Ø¨Ù‘Ù‡
    if (currentUser && currentUser.role === 'ÙˆÙƒÙŠÙ„') {
      // Ø§Ù„ØªÙØµÙŠÙ„: ÙŠÙ…ÙƒÙ† Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø·ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø­Ø¯Ø« Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯
      // Ø³Ù†Ø¨Ù‚ÙŠÙ‡Ø§ Ø¨Ø³ÙŠØ·Ø©: Ù†Ø®Ø¨Ø± Ø§Ù„ÙˆÙƒÙŠÙ„ Ø£Ù† Ù‡Ù†Ø§Ùƒ ØªØ­Ø¯ÙŠØ«
      alert('ğŸ”” ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ â€” ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡.');
    }
  }
  if (e.key === MESSAGES_KEY) {
    // Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø± â€” Ø­Ø¯Ù‘Ø« Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù† ÙƒÙ†Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    messages = JSON.parse(localStorage.getItem(MESSAGES_KEY)) || [];
    // Ø¥Ø°Ø§ ØµÙØ­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ÙØªÙˆØ­Ø© â€” Ø­Ø¯Ø« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    if (document.querySelector('#chat')?.classList.contains('active')) renderMessages();
  }
});

/* ===== Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø¨Ø¹Ø¯ Ø§Ù„Ù‚ÙÙ„ ÙˆØ§Ù„Ø³Ù„Ø§Ø´) ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø£ÙˆÙ„ÙŠØ©
  users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY)) || null;
  messages = JSON.parse(localStorage.getItem(MESSAGES_KEY)) || [];
  // Ø¶Ø¹ Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù€ Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (Enter)
  document.getElementById('accessCode').addEventListener('keydown', (e)=>{ if(e.key==='Enter') lockBtn.click(); });
  // Ø²Ø± Ø¥Ø±Ø³Ù€Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Enter
  document.getElementById('chatInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„Ù‚ÙÙ„
  unlockFlow();
});

/* ===== Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø§Ø¬Ø¹Ù„ ØµÙØ­Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ ===== */
/* (Ù„Ùˆ ØªØ±ÙŠØ¯ Ø£Ù† ÙŠØ¹Ø±Ø¶ ÙÙˆØ±Ù‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¯ÙˆÙ† ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡) â€” Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø°Ù„Ùƒ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¨Ø± showSection('users') Ø¥Ù† Ø±ØºØ¨Øª */
/* Ù„ÙƒÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù†Ø¹Ø±Ø¶ welcome ÙÙ‚Ø·Ø› ÙŠÙ…ÙƒÙ† Ù„Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡. */

</script>
</body>
</html>

