<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام الأعضاء — محفوظ محليًا</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#e8f6ff; direction: rtl; text-align: right; }
    .navbar { position:fixed; top:0; right:0; width:100%; background:#007bff; display:flex; flex-direction:row-reverse; justify-content:flex-start; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:1000;}
    .navbar button { background:#fff; color:#007bff; border:none; padding:10px 18px; margin-left:10px; border-radius:8px; cursor:pointer; }
    .navbar button.active { background:#003f7f; color:#fff; font-weight:bold; box-shadow:0 0 8px rgba(0,0,0,0.25); }
    .fixed-image { position:fixed; top:70px; left:10px; width:110px; border-radius:8px; z-index:999; }
    .content { padding:100px 20px; max-width:1000px; margin:0 auto; }
    .section { display:none; }
    .section.active { display:block; animation:fadeIn .3s ease; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .box { background:#fff; padding:18px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); max-width:600px; margin:auto; }
    input, select, button { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #ccc; font-size:15px; box-sizing:border-box; }
    .user-list { background:#fff; padding:12px; border-radius:8px; box-shadow:0 1px 5px rgba(0,0,0,0.05); max-width:700px; margin:auto; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:center; }
    th { background:#007bff; color:#fff; }
    .chat-box { max-width:600px; margin:auto; background:#fff; padding:12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; flex-direction:column; height:420px; }
    .messages { flex:1; overflow-y:auto; padding:10px; border:1px solid #eee; border-radius:8px; background:#fafafa; margin-bottom:10px; }
    .message { background:#dff1ff; padding:8px 10px; border-radius:8px; margin:6px 0; }
    .message .meta { font-weight:bold; color:#034a7f; margin-bottom:4px; }
    .small { font-size:13px; color:#666; }
    .center { text-align:center; }
  </style>
</head>
<body>

  <div class="navbar">
    <button onclick="showSection('home')">الرئيسية</button>
    <button onclick="showSection('about')">حول</button>
    <button onclick="showSection('dna')">انضمام</button>
    <button onclick="showSection('users')" id="membersBtn">الأعضاء</button>
    <button onclick="showSection('chat')" id="chatBtn" class="hidden">الدردشة</button>
  </div>

  <!-- اختياري: لو عندك صورة ضع اسمها هنا -->
  <img src="DNA.png" alt="logo" class="fixed-image" onerror="this.style.display='none'">

  <div class="content">
    <div id="home" class="section active">
      <div class="box">
        <h2>مرحبًا</h2>
        <p class="small">هذا النظام يخزن حسابات الأعضاء محليًا في المتصفح (localStorage) حتى لا تُحذف عند إعادة التحميل. لا توجد آلية حذف عبر الواجهة — البيانات تبقى محفوظة حتى تمسحها من المتصفح.</p>
        <p class="small">ملاحظة: إذا أردت حذف الحسابات يدوياً يمكنك فتح أدوات المطور في المتصفح → Application → Local Storage → وحذف المفتاح "users" أو "currentUser".</p>
      </div>
    </div>

    <div id="about" class="section">
      <div class="box">
        <h2>عن النظام</h2>
        <p class="small">نظام تسجيل بسيط: كل عضو يملأ الاسم والعمر ويختار دوره (عضو أو وكيل). فقط وكيل واحد مسموح. الحسابات محفوظة محليًا ولا تحذف تلقائيًا.</p>
      </div>
    </div>

    <div id="dna" class="section">
      <div id="rulesBox" class="box">
        <h3>📜 القواعد والشروط</h3>
        <ul>
          <li>الاحترام واجب.</li>
          <li>لا يُسمح بأكثر من وكيل واحد.</li>
          <li>يجب عدم استخدام أسماء مزيفة.</li>
        </ul>
        <div class="center"><button onclick="agreeRules()">أوافق وأكمل التسجيل</button></div>
      </div>

      <form id="voteForm" class="box hidden">
        <h3>نموذج التسجيل</h3>
        <label>الاسم:</label>
        <input type="text" id="name" placeholder="الاسم الكامل" required>

        <label>العمر:</label>
        <input type="number" id="age" placeholder="العمر" required min="1">

        <label>الدور:</label>
        <select id="role" required>
          <option value="">اختر...</option>
          <option value="وكيل">وكيل</option>
          <option value="عضو">عضو</option>
        </select>

        <button type="submit">تسجيل</button>
      </form>

      <div id="welcomeBox" class="box hidden">
        <h3 id="welcomeTitle"></h3>
        <p class="small">لقد تم حفظ حسابك محليًا ولن يُحذف تلقائيًا. يمكنك الآن الوصول إلى الدردشة والصفحات المخصصة للأعضاء.</p>
      </div>
    </div>

    <div id="users" class="section">
      <h2 class="center">قائمة الأعضاء المسجلين</h2>
      <div id="userList" class="user-list box"></div>
    </div>

    <div id="chat" class="section">
      <h2 class="center">دردشة الأعضاء</h2>
      <div class="chat-box">
        <div id="messages" class="messages"></div>
        <input id="chatInput" type="text" placeholder="اكتب رسالتك ثم اضغط Enter" onkeydown="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">إرسال</button>
      </div>
    </div>

  </div>

<script>
  // مفاتيح التخزين
  const USERS_KEY = 'users';
  const CURRENT_KEY = 'currentUser';
  const MESSAGES_KEY = 'messages';

  // حالة التطبيق محليًا
  let users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  let currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY)) || null;
  let messages = JSON.parse(localStorage.getItem(MESSAGES_KEY)) || [];

  // عند تحميل الصفحة: إعداد العرض بناءً على وجود مستخدم
  document.addEventListener('DOMContentLoaded', () => {
    // إظهار زر الدردشة فقط إذا كان هناك مستخدم مسجّل (currentUser)
    updateChatButton();
    // عند وجود مستخدم حالٍ أعرض رسالة ترحيبية
    if (currentUser) showWelcome(currentUser);
    updateMembersButton();
  });

  // التنقّل بين الأقسام
  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) el.classList.add('active');

    // تعيين تمييز الزر
    document.querySelectorAll('.navbar button').forEach(b => b.classList.remove('active'));
    // استخدام event.target قد لا يعمل عند استدعاء برمجيًا، فلنجعل التمييز يدويًا:
    const btns = Array.from(document.querySelectorAll('.navbar button'));
    const match = btns.find(b => b.getAttribute('onclick') && b.getAttribute('onclick').includes(`'${id}'`));
    if (match) match.classList.add('active');

    // إذا دخل المستخدم على صفحة الأعضاء أو الدردشة حدّث العرض
    if (id === 'users') renderUsers();
    if (id === 'chat') renderMessages();
  }

  // القواعد → إظهار نموذج التسجيل بعد الموافقة
  function agreeRules() {
    document.getElementById('rulesBox').classList.add('hidden');
    document.getElementById('voteForm').classList.remove('hidden');
  }

  // إرسال نموذج التسجيل
  document.getElementById('voteForm').addEventListener('submit', function(e){
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const age = document.getElementById('age').value.trim();
    const role = document.getElementById('role').value;

    if (!name || !age || !role) {
      alert('يرجى ملء جميع الحقول.');
      return;
    }

    // التحقق من وجود وكيل من قبل (مستمر عبر إعادة التحميل لأننا نحمل users من localStorage)
    if (role === 'وكيل' && users.some(u => u.role === 'وكيل')) {
      alert('⚠️ بالفعل هناك وكيل واحد مسجل. لا يمكن إضافة وكيل آخر.');
      return;
    }

    // منع التكرار بنفس الاسم (اختياري)
    if (users.some(u => u.name === name && u.age === age && u.role === role)) {
      alert('هذا الحساب مسجل مسبقًا.');
      // يمكنك اختيار ألا تفعل شيئًا أو تسجيل تكرار؛ هنا نمنع التكرار.
      return;
    }

    // إنشاء الحساب وحفظه
    const newUser = { name, age, role, createdAt: new Date().toISOString() };
    users.push(newUser);
    localStorage.setItem(USERS_KEY, JSON.stringify(users));

    // تعيين المستخدم الحالي وحفظه (يضمن بقاءه "مسجلاً")
    currentUser = newUser;
    localStorage.setItem(CURRENT_KEY, JSON.stringify(currentUser));

    // إعداد الواجهة بعد التسجيل
    showWelcome(newUser);
    updateChatButton();
    updateMembersButton();
    alert('✅ تم تسجيل الحساب وحفظه محليًا.');
    // مسح الحقول
    this.reset();
  });

  // إظهار ترحيب بعد التسجيل أو إذا المستخدم بالفعل مسجّل
  function showWelcome(user) {
    document.getElementById('voteForm').classList.add('hidden');
    document.getElementById('rulesBox').classList.add('hidden');
    const w = document.getElementById('welcomeBox');
    w.classList.remove('hidden');
    document.getElementById('welcomeTitle').innerText = `مرحبًا ${user.name} — أنت مسجل كـ ${user.role}`;
  }

  // زر الدردشة مرئي فقط عند وجود currentUser
  function updateChatButton(){
    const btn = document.getElementById('chatBtn');
    if (currentUser) btn.classList.remove('hidden'); else btn.classList.add('hidden');
  }

  function updateMembersButton(){
    const btn = document.getElementById('membersBtn');
    if (users.length > 0) btn.disabled = false; else btn.disabled = false; // ما زلنا نتركه متاحًا دائماً
  }

  // عرض الأعضاء من localStorage
  function renderUsers(){
    const el = document.getElementById('userList');
    if (users.length === 0) {
      el.innerHTML = '<p class="center small">لا يوجد أعضاء مسجلين بعد.</p>';
      return;
    }
    // جدول مرتب
    let html = `<table><thead><tr><th>الاسم</th><th>العمر</th><th>الدور</th><th>مسجل منذ</th></tr></thead><tbody>`;
    users.forEach(u => {
      html += `<tr><td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.age)}</td><td>${escapeHtml(u.role)}</td><td class="small">${new Date(u.createdAt).toLocaleString()}</td></tr>`;
    });
    html += `</tbody></table>`;
    el.innerHTML = html;
  }

  // --- دردشة محلية محفوظة ---
  function sendMessage(){
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;
    if (!currentUser) { alert('يجب التسجيل أولاً للدخول إلى الدردشة.'); return; }

    const msg = { user: currentUser.name, role: currentUser.role, text, time: new Date().toISOString() };
    messages.push(msg);
    localStorage.setItem(MESSAGES_KEY, JSON.stringify(messages));
    input.value = '';
    renderMessages();
  }

  function renderMessages(){
    const box = document.getElementById('messages');
    if (!messages || messages.length === 0) { box.innerHTML = '<p class="small center">لا توجد رسائل بعد.</p>'; return; }
    box.innerHTML = messages.map(m => {
      // يميز اسم الوكيل بلون (ويمكن تغييره عبر CSS لاحقًا)
      const roleMark = m.role === 'وكيل' ? ' (وكيل)' : '';
      return `<div class="message"><div class="meta">${escapeHtml(m.user)}${roleMark} <span class="small">— ${new Date(m.time).toLocaleString()}</span></div><div>${escapeHtml(m.text)}</div></div>`;
    }).join('');
    box.scrollTop = box.scrollHeight;
  }

  // دالة صغيرة لتعقيم نص المستخدم قبل الإدراج في HTML
  function escapeHtml(str){
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  // اختياري: دالة لمسح البيانات (لن نوفرها في الواجهة حسب طلبك "لا حذف")
  // لكن إن احتجت لمسح التخزين خلال التطوير:
  // function clearAllLocalData(){ localStorage.removeItem(USERS_KEY); localStorage.removeItem(CURRENT_KEY); localStorage.removeItem(MESSAGES_KEY); location.reload(); }

  // لاحقًا: إذا أردت تسجيل خروج المستخدم الحالي دون حذف الحساب، يمكنك فعل:
  // function logout() { currentUser = null; localStorage.removeItem(CURRENT_KEY); updateChatButton(); }

</script>
</body>
</html>
