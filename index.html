<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>نظام الأعضاء — إدارة الوكيل</title>
<style>
body {
  margin:0; font-family: Arial, sans-serif;
  background:#e8f6ff; direction: rtl; text-align: right;
  opacity:0; transition: opacity 1.5s ease;
}

/* ===== شاشة الترحيب ===== */
#splashScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: #f8f4ec;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 1s ease;
}
#splashScreen img {
  max-width: 300px;
  width: 60%;
  height: auto;
}
.hiddenSplash {
  opacity: 0;
  pointer-events: none;
}

/* ===== تصميم الواجهة ===== */
.navbar {
  position:fixed; top:0; right:0; width:100%;
  background:#007bff; display:flex; flex-direction:row-reverse;
  justify-content:flex-start; padding:10px;
  box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:1000;
}
.navbar button {
  background:#fff; color:#007bff; border:none;
  padding:10px 18px; margin-left:10px; border-radius:8px; cursor:pointer;
}
.navbar button.active {
  background:#003f7f; color:#fff; font-weight:bold;
  box-shadow:0 0 8px rgba(0,0,0,0.25);
}
.fixed-image {
  position:fixed; top:70px; left:10px; width:110px;
  border-radius:8px; z-index:999;
}
.content { padding:100px 20px; max-width:1000px; margin:0 auto; opacity:1; transition:opacity 1.5s ease; }
.section { display:none; }
.section.active { display:block; animation:fadeIn .3s ease; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.box {
  background:#fff; padding:18px; border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  max-width:600px; margin:auto;
}
input, select, button {
  width:100%; padding:10px; margin:10px 0;
  border-radius:8px; border:1px solid #ccc;
  font-size:15px; box-sizing:border-box;
}
.user-list {
  background:#fff; padding:12px; border-radius:8px;
  box-shadow:0 1px 5px rgba(0,0,0,0.05);
  max-width:700px; margin:auto;
}
table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
th, td { padding:10px; border-bottom:1px solid #eee; text-align:center; }
th { background:#007bff; color:#fff; }
.chat-box {
  max-width:600px; margin:auto; background:#fff; padding:12px;
  border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08);
  display:flex; flex-direction:column; height:420px;
}
.messages {
  flex:1; overflow-y:auto; padding:10px;
  border:1px solid #eee; border-radius:8px;
  background:#fafafa; margin-bottom:10px;
}
.message { background:#dff1ff; padding:8px 10px; border-radius:8px; margin:6px 0; }
.message .meta { font-weight:bold; color:#034a7f; margin-bottom:4px; }
.small { font-size:13px; color:#666; }
.center { text-align:center; }
.hidden { display:none; }
.delete-btn, .mute-btn, .clear-btn {
  background:#ff5252; color:white; border:none;
  padding:5px 10px; border-radius:6px; cursor:pointer;
}
.mute-btn { background:#ff9800; }
.clear-btn { background:#007bff; margin-bottom:10px; }
</style>
</head>

<body>

<!-- شاشة الترحيب -->
<div id="splashScreen">
  <img src="Democratic Negotiation Agency Emblem.png" alt="DNA Logo">
</div>

<div class="navbar">
  <button onclick="showSection('home')">الرئيسية</button>
  <button onclick="showSection('about')">حول</button>
  <button onclick="showSection('dna')">انضمام</button>
  <button onclick="showSection('users')" id="membersBtn">الأعضاء</button>
  <button onclick="showSection('chat')" id="chatBtn" class="hidden">الدردشة</button>
</div>

<img src="DNA.png" alt="logo" class="fixed-image" onerror="this.style.display='none'">

<div class="content">
  <div id="home" class="section active">
    <div class="box">
      <h2>مرحبًا</h2>
      <p class="small">هذا النظام يخزن حسابات الأعضاء محليًا في المتصفح (localStorage) حتى لا تُحذف عند إعادة التحميل.</p>
      <p class="small">يمكن للوكيل حذف الأعضاء أو منعهم من الدردشة أو مسح الدردشة للجميع.</p>
    </div>
  </div>

  <div id="about" class="section">
    <div class="box">
      <h2>عن النظام</h2>
      <p class="small">نظام إدارة بسيط: وكيل واحد فقط يستطيع التحكم بالأعضاء (الحذف، المنع من الدردشة، مسح الرسائل).</p>
    </div>
  </div>

  <div id="dna" class="section">
    <div id="rulesBox" class="box">
      <h3>📜 القواعد والشروط</h3>
      <ul>
        <li>الاحترام واجب.</li>
        <li>لا يُسمح بأكثر من وكيل واحد.</li>
        <li>يجب عدم استخدام أسماء مزيفة.</li>
      </ul>
      <div class="center"><button onclick="agreeRules()">أوافق وأكمل التسجيل</button></div>
    </div>

    <form id="voteForm" class="box hidden">
      <h3>نموذج التسجيل</h3>
      <label>الاسم:</label>
      <input type="text" id="name" placeholder="الاسم الكامل" required>
      <label>العمر:</label>
      <input type="number" id="age" placeholder="العمر" required min="1">
      <label>الدور:</label>
      <select id="role" required>
        <option value="">اختر...</option>
        <option value="وكيل">وكيل</option>
        <option value="عضو">عضو</option>
      </select>
      <button type="submit">تسجيل</button>
    </form>

    <div id="welcomeBox" class="box hidden">
      <h3 id="welcomeTitle"></h3>
      <p class="small">تم حفظ حسابك ولن يُحذف تلقائيًا. يمكنك الآن الوصول إلى الدردشة وصفحة الأعضاء.</p>
    </div>
  </div>

  <div id="users" class="section">
    <h2 class="center">قائمة الأعضاء المسجلين</h2>
    <div id="userList" class="user-list box"></div>
  </div>

  <div id="chat" class="section">
    <h2 class="center">دردشة الأعضاء</h2>
    <div class="chat-box">
      <div id="agentTools" class="hidden center">
        <button class="clear-btn" onclick="clearChat()">🧹 مسح الدردشة للجميع</button>
      </div>
      <div id="messages" class="messages"></div>
      <input id="chatInput" type="text" placeholder="اكتب رسالتك ثم اضغط Enter" onkeydown="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()">إرسال</button>
    </div>
  </div>
</div>

<script>
const USERS_KEY = 'users';
const CURRENT_KEY = 'currentUser';
const MESSAGES_KEY = 'messages';
let users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
let currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY)) || null;
let messages = JSON.parse(localStorage.getItem(MESSAGES_KEY)) || [];

document.addEventListener('DOMContentLoaded', () => {
  updateChatButton();
  if (currentUser) showWelcome(currentUser);
  // عند تحميل الصفحة، ابدأ بإخفاء شاشة الترحيب
  window.addEventListener('load', () => {
    const splash = document.getElementById('splashScreen');
    setTimeout(() => {
      splash.classList.add('hiddenSplash');
      document.body.style.opacity = 1;
      setTimeout(() => splash.remove(), 1000);
    }, 2000);
  });
});

function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
  document.querySelectorAll('.navbar button').forEach(b => b.classList.remove('active'));
  const match = Array.from(document.querySelectorAll('.navbar button')).find(b => b.getAttribute('onclick')?.includes(`'${id}'`));
  if (match) match.classList.add('active');
  if (id === 'users') renderUsers();
  if (id === 'chat') renderChat();
}

function agreeRules() {
  document.getElementById('rulesBox').classList.add('hidden');
  document.getElementById('voteForm').classList.remove('hidden');
}

document.getElementById('voteForm').addEventListener('submit', function(e){
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const role = document.getElementById('role').value;
  if (!name || !age || !role) return alert('يرجى ملء جميع الحقول.');
  if (role === 'وكيل' && users.some(u => u.role === 'وكيل')) return alert('⚠️ هناك وكيل بالفعل.');
  if (users.some(u => u.name === name)) return alert('هذا الاسم مسجل مسبقًا.');
  const newUser = { name, age, role, muted:false, createdAt: new Date().toISOString() };
  users.push(newUser);
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  currentUser = newUser;
  localStorage.setItem(CURRENT_KEY, JSON.stringify(currentUser));
  showWelcome(newUser);
  updateChatButton();
  alert('✅ تم التسجيل بنجاح.');
  this.reset();
});

function showWelcome(user) {
  document.getElementById('voteForm').classList.add('hidden');
  document.getElementById('rulesBox').classList.add('hidden');
  const w = document.getElementById('welcomeBox');
  w.classList.remove('hidden');
  document.getElementById('welcomeTitle').innerText = `مرحبًا ${user.name} — أنت ${user.role}`;
}

function updateChatButton(){
  const btn = document.getElementById('chatBtn');
  if (currentUser) btn.classList.remove('hidden'); else btn.classList.add('hidden');
}

function renderUsers(){
  const el = document.getElementById('userList');
  if (users.length === 0) return el.innerHTML = '<p class="center small">لا يوجد أعضاء.</p>';
  let html = `<table><thead><tr><th>الاسم</th><th>العمر</th><th>الدور</th><th>تاريخ التسجيل</th><th>إجراءات</th></tr></thead><tbody>`;
  users.forEach((u,i) => {
    html += `<tr>
      <td>${escapeHtml(u.name)}</td>
      <td>${escapeHtml(u.age)}</td>
      <td>${escapeHtml(u.role)}</td>
      <td class="small">${new Date(u.createdAt).toLocaleString()}</td>
      <td>
        ${currentUser && currentUser.role === 'وكيل' && u.name !== currentUser.name ? `
          <button class="mute-btn" onclick="toggleMute(${i})">${u.muted ? 'إلغاء المنع' : 'منع من الدردشة'}</button>
          <button class="delete-btn" onclick="deleteUser(${i})">حذف</button>` : '-'}
      </td>
    </tr>`;
  });
  html += `</tbody></table>`;
  el.innerHTML = html;
}

function toggleMute(index){
  users[index].muted = !users[index].muted;
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  renderUsers();
  alert(users[index].muted ? '🚫 تم منع العضو من الدردشة' : '✅ تم السماح له مجددًا');
}

function deleteUser(index){
  if (!currentUser || currentUser.role !== 'وكيل') return alert('❌ فقط الوكيل يمكنه حذف الأعضاء.');
  if (!confirm('هل أنت متأكد من حذف هذا العضو؟')) return;
  const removed = users.splice(index,1)[0];
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  renderUsers();
  alert('🗑️ تم حذف العضو.');
}

function renderChat(){
  const tools = document.getElementById('agentTools');
  if (currentUser && currentUser.role === 'وكيل') tools.classList.remove('hidden');
  else tools.classList.add('hidden');
  renderMessages();
}

function clearChat(){
  if (!currentUser || currentUser.role !== 'وكيل') return alert('❌ فقط الوكيل يمكنه مسح الدردشة.');
  if (!confirm('هل تريد مسح جميع الرسائل؟')) return;
  messages = [];
  localStorage.setItem(MESSAGES_KEY, JSON.stringify(messages));
  renderMessages();
  alert('🧹 تم مسح الدردشة بنجاح.');
}

function sendMessage(){
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !currentUser) return;
  if (currentUser.muted) return alert('🚫 تم منعك من إرسال الرسائل.');
  const msg = { user: currentUser.name, role: currentUser.role, text, time: new Date().toISOString() };
  messages.push(msg);
  localStorage.setItem(MESSAGES_KEY, JSON.stringify(messages));
  input.value = '';
  renderMessages();
}

function renderMessages(){
  const box = document.getElementById('messages');
  if (messages.length === 0) return box.innerHTML = '<p class="small center">لا توجد رسائل بعد.</p>';
  box.innerHTML = messages.map(m=>{
    const mark = m.role === 'وكيل' ? ' (وكيل)' : '';
    return `<div class="message"><div class="meta">${escapeHtml(m.user)}${mark} <span class="small">— ${new Date(m.time).toLocaleString()}</span></div><div>${escapeHtml(m.text)}</div></div>`;
  }).join('');
  box.scrollTop = box.scrollHeight;
}

function escapeHtml(str){ return str?.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))||''; }
</script>

</body>
</html>
