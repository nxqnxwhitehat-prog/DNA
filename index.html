<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>نظام الأعضاء — إدارة الوكيل (DNA)</title>
<style>
/* ----- عام ----- */
:root{--blue:#007bff;--dark:#003f7f;--muted:#ff9800;--danger:#ff5252}
*{box-sizing:border-box}
body {
  margin:0; font-family: Arial, sans-serif;
  background:#e8f6ff; direction: rtl; text-align: right;
  -webkit-font-smoothing:antialiased;
}

/* ----- شاشة القفل ----- */
#lockScreen {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:radial-gradient(circle at center, #001d3d 0%, #000814 100%);
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  z-index:4000; overflow:hidden; color:white; text-align:center;
}
#lockScreen::before {
  content:''; position:absolute; top:0; left:0; width:100%; height:100%;
  background:url('Democratic Negotiation Agency Emblem.png') center/280px no-repeat;
  opacity:0.08; filter:blur(3px);
}
#lockBox {
  position:relative; z-index:10; background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12); border-radius:14px;
  padding:34px 26px; text-align:center; backdrop-filter:blur(6px);
  box-shadow:0 6px 30px rgba(0,0,0,0.45); color:#fff; width:92%; max-width:380px;
}
#lockBox h2{margin:0 0 14px 0}
#lockBox input {
  padding:12px; width:80%; border-radius:10px; border:none;
  text-align:center; font-size:16px; margin-bottom:12px; outline:none;
}
#lockBox button {
  padding:10px 22px; background:var(--blue); color:white; border:none;
  border-radius:8px; cursor:pointer; font-size:15px;
}
#lockBox button:hover{background:var(--dark)}
#lockError {color:#ff6b6b; display:none; margin-top:10px; font-weight:700}

/* ----- شاشة الترحيب (splash) ----- */
#splash {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:#f8f8f8; display:flex; justify-content:center; align-items:center;
  z-index:3000; opacity:1; transition:opacity .8s ease;
}
#splash img { width:300px; max-width:80%; }

/* ----- شريط التنقل ----- */
.navbar {
  position:fixed; top:0; right:0; width:100%;
  background:var(--blue); display:flex; flex-direction:row-reverse;
  justify-content:flex-start; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.12);
  z-index:1000;
}
.navbar button {
  background:#fff; color:var(--blue); border:none;
  padding:10px 18px; margin-left:10px; border-radius:8px; cursor:pointer;
}
.navbar button.active { background:var(--dark); color:#fff; font-weight:bold; box-shadow:0 0 8px rgba(0,0,0,0.18); }

/* ----- محتوى الصفحة ----- */
.fixed-image {
  position:fixed; top:70px; left:10px; width:110px; border-radius:8px; z-index:999;
}
.content { padding:100px 20px; max-width:1000px; margin:0 auto; }
.section { display:none; }
.section.active { display:block; animation:fadeIn .25s ease; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.box {
  background:#fff; padding:18px; border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08); max-width:760px; margin:auto;
}
input, select, button {
  width:100%; padding:10px; margin:10px 0; border-radius:8px;
  border:1px solid #ccc; font-size:15px; box-sizing:border-box;
}
.user-list {
  background:#fff; padding:12px; border-radius:8px;
  box-shadow:0 1px 5px rgba(0,0,0,0.05); max-width:820px; margin:auto;
}
table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
th, td { padding:10px; border-bottom:1px solid #eee; text-align:center; }
th { background:var(--blue); color:#fff; }
.chat-box {
  max-width:760px; margin:auto; background:#fff; padding:12px;
  border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08);
  display:flex; flex-direction:column; height:420px;
}
.messages {
  flex:1; overflow-y:auto; padding:10px; border:1px solid #eee; border-radius:8px;
  background:#fafafa; margin-bottom:10px;
}
.message { background:#dff1ff; padding:8px 10px; border-radius:8px; margin:6px 0; }
.message .meta { font-weight:bold; color:#034a7f; margin-bottom:4px; }
.small { font-size:13px; color:#666; }
.center { text-align:center; }
.delete-btn, .mute-btn, .clear-btn { background:var(--danger); color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
.mute-btn { background:var(--muted); }
.clear-btn { background:var(--blue); }
.hidden { display:none; }

/* responsive */
@media (max-width:600px){
  #lockBox{padding:24px}
  .fixed-image{display:none}
  .chat-box{height:360px}
}
</style>
</head>

<body>

<!-- شاشة القفل (رمز الدخول) -->
<div id="lockScreen">
  <div id="lockBox">
    <h2>🔒 أدخل رمز الدخول للموقع</h2>
    <input type="password" id="accessCode" placeholder="رمز الدخول">
    <br>
    <button id="lockBtn">دخول</button>
    <p id="lockError">الرمز غير صحيح ❌</p>
  </div>
</div>

<!-- شاشة الترحيب (تظهر بعد القفل) -->
<div id="splash" class="hidden">
  <img src="Democratic Negotiation Agency Emblem.png" alt="DNA Logo">
</div>

<!-- شريط التنقل والمحتوى الرئيسي (مخفي حتى اختفاء القفل + السلاش) -->
<div id="mainApp" class="hidden">
  <div class="navbar">
    <button onclick="showSection('home')" class="active">الرئيسية</button>
    <button onclick="showSection('about')">حول</button>
    <button onclick="showSection('dna')">انضمام</button>
    <button onclick="showSection('users')" id="membersBtn">الأعضاء</button>
    <button onclick="showSection('chat')" id="chatBtn" class="hidden">الدردشة</button>
  </div>

  <img src="DNA.png" alt="logo" class="fixed-image" onerror="this.style.display='none'">

  <div class="content">
    <div id="home" class="section active">
      <div class="box">
        <h2>مرحبًا</h2>
        <p class="small">هذا النظام يخزن حسابات الأعضاء محليًا في المتصفح (localStorage) حتى لا تُحذف عند إعادة التحميل.</p>
        <p class="small">الوكيل يمتلك صلاحيات الإدارة (حذف/منع/مسح دردشة).</p>
      </div>
    </div>

    <div id="about" class="section">
      <div class="box">
        <h2>عن النظام</h2>
        <p class="small">نظام إدارة بسيط: كل مستخدم يسجل اسم وعمر ويختار الدور (عضو أو وكيل). فقط وكيل واحد مسموح.</p>
      </div>
    </div>

    <div id="dna" class="section">
      <div id="rulesBox" class="box">
        <h3>📜 القواعد والشروط</h3>
        <ul>
          <li>الاحترام واجب.</li>
          <li>لا يُسمح بأكثر من وكيل واحد.</li>
          <li>يجب عدم استخدام أسماء مزيفة.</li>
        </ul>
        <div class="center"><button onclick="agreeRules()">أوافق وأكمل التسجيل</button></div>
      </div>

      <form id="voteForm" class="box hidden">
        <h3>نموذج التسجيل</h3>
        <label>الاسم:</label>
        <input type="text" id="name" placeholder="الاسم الكامل" required>
        <label>العمر:</label>
        <input type="number" id="age" placeholder="العمر" required min="1">
        <label>الدور:</label>
        <select id="role" required>
          <option value="">اختر...</option>
          <option value="وكيل">وكيل</option>
          <option value="عضو">عضو</option>
        </select>
        <button type="submit">تسجيل</button>
      </form>

      <div id="welcomeBox" class="box hidden">
        <h3 id="welcomeTitle"></h3>
        <p class="small">تم حفظ حسابك محليًا. يمكنك الآن الوصول إلى الدردشة وصفحة الأعضاء (حسب الصلاحية).</p>
      </div>
    </div>

    <div id="users" class="section">
      <h2 class="center">قائمة الأعضاء المسجلين</h2>
      <div id="userList" class="user-list box"></div>
    </div>

    <div id="chat" class="section">
      <h2 class="center">دردشة الأعضاء</h2>
      <div class="chat-box">
        <div id="agentTools" class="hidden center" style="margin-bottom:8px;">
          <button class="clear-btn" onclick="clearChat()">🧹 مسح الدردشة للجميع</button>
        </div>
        <div id="messages" class="messages"></div>
        <input id="chatInput" type="text" placeholder="اكتب رسالتك ثم اضغط Enter" onkeydown="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">إرسال</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== مفاتيح التخزين ===== */
const USERS_KEY = 'users';
const CURRENT_KEY = 'currentUser';
const MESSAGES_KEY = 'messages';
const ACCESS_KEY = 'accessUnlocked'; // لتخزين حالة فتح القفل (اختياري)
let users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
let currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY)) || null;
let messages = JSON.parse(localStorage.getItem(MESSAGES_KEY)) || [];

/* ===== عناصر DOM ===== */
const lockScreen = document.getElementById('lockScreen');
const lockBtn = document.getElementById('lockBtn');
const lockError = document.getElementById('lockError');
const splash = document.getElementById('splash');
const mainApp = document.getElementById('mainApp');
const chatBtn = document.getElementById('chatBtn');

/* ===== تحقق رمز الدخول (123456789) ===== */
function unlockFlow() {
  // إذا محترف: يمكنك حفظ مفتاح ACCESS_KEY ليبقى مفتوحًا، هنا لا نحفظه افتراضياً
  // افحص ما إذا كان ACCESS_KEY محفوظًا لتجاوز القفل (اختياري)
  const unlocked = sessionStorage.getItem(ACCESS_KEY) === '1';
  if (unlocked) {
    startSplashAndShowApp();
  } else {
    lockScreen.style.display = 'flex';
  }
}

lockBtn.addEventListener('click', () => {
  const val = document.getElementById('accessCode').value.trim();
  if (val === '123456789') {
    // احفظ في sessionStorage ليبقى مفتوح خلال الجلسة (تستطيع تغييره)
    sessionStorage.setItem(ACCESS_KEY, '1');
    lockScreen.style.display = 'none';
    startSplashAndShowApp();
  } else {
    lockError.style.display = 'block';
  }
});

/* ===== شاشة الترحيب ثم إظهار التطبيق ===== */
function startSplashAndShowApp(){
  splash.classList.remove('hidden');
  // نظف أي عرض سابق
  setTimeout(()=>{
    splash.style.opacity = '0';
    setTimeout(()=>{
      splash.style.display = 'none';
      // إظهار التطبيق الرئيسي
      mainApp.classList.remove('hidden');
      // تحميل بيانات محدثة
      loadState();
      updateChatButton();
      if (currentUser) showWelcome(currentUser);
      // تنبيه ترحيبي
      alert('🖐️ مرحبًا بك في وكالة المفاوضات الديمقراطية (DNA)');
    },800);
  },2000);
}

/* ===== تحميل الحالة من التخزين ===== */
function loadState(){
  users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY)) || null;
  messages = JSON.parse(localStorage.getItem(MESSAGES_KEY)) || [];
}

/* ===== التنقل بين الأقسام ===== */
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
  document.querySelectorAll('.navbar button').forEach(b => b.classList.remove('active'));
  const match = Array.from(document.querySelectorAll('.navbar button')).find(b => (b.getAttribute('onclick')||'').includes(`'${id}'`));
  if (match) match.classList.add('active');

  if (id === 'users') {
    // تأكد من تحديث القائمة من localStorage عند كل فتح
    users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
    renderUsers();
  }
  if (id === 'chat') renderChat();
}

/* ===== التسجيل (القواعد → نموذج → تسجيل) ===== */
function agreeRules(){
  document.getElementById('rulesBox').classList.add('hidden');
  document.getElementById('voteForm').classList.remove('hidden');
}

document.getElementById('voteForm').addEventListener('submit', function(e){
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const role = document.getElementById('role').value;
  if (!name || !age || !role) { alert('يرجى ملء جميع الحقول.'); return; }
  if (role === 'وكيل' && users.some(u => u.role === 'وكيل')) { alert('⚠️ هناك وكيل بالفعل.'); return; }
  if (users.some(u => u.name === name)) { alert('هذا الاسم مسجل مسبقًا.'); return; }
  const newUser = { name, age, role, muted:false, createdAt: new Date().toISOString() };
  users.push(newUser);
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  // تعيين المستخدم الحالي
  currentUser = newUser;
  localStorage.setItem(CURRENT_KEY, JSON.stringify(currentUser));
  // اشعار الوكيل (محلي) — سيتم التعامل عبر حدث التخزين أيضًا لعلامات تبويب أخرى
  notifyAgentNewUser(newUser);
  showWelcome(newUser);
  updateChatButton();
  alert('✅ تم التسجيل بنجاح.');
  this.reset();
});

/* ===== إظهار ترحيب للمستخدم الحالي ===== */
function showWelcome(user){
  document.getElementById('voteForm').classList.add('hidden');
  document.getElementById('rulesBox').classList.add('hidden');
  const w = document.getElementById('welcomeBox');
  w.classList.remove('hidden');
  document.getElementById('welcomeTitle').innerText = `مرحبًا ${user.name} — أنت ${user.role}`;
}

/* ===== زر الدردشة مرئي فقط عند تسجيل الدخول ===== */
function updateChatButton(){
  const btn = document.getElementById('chatBtn');
  if (currentUser) btn.classList.remove('hidden'); else btn.classList.add('hidden');
}

/* ===== عرض الأعضاء (زر حذف/منع يظهر فقط للوكيل) ===== */
function renderUsers(){
  const el = document.getElementById('userList');
  users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  if (users.length === 0) { el.innerHTML = '<p class="center small">لا يوجد أعضاء.</p>'; return; }
  const isAgent = currentUser && currentUser.role === 'وكيل';
  let html = `<table><thead><tr><th>الاسم</th><th>العمر</th><th>الدور</th><th>تاريخ التسجيل</th>${isAgent?'<th>إجراءات</th>':''}</tr></thead><tbody>`;
  users.forEach((u,i)=>{
    html += `<tr>
      <td>${escapeHtml(u.name)}</td>
      <td>${escapeHtml(u.age)}</td>
      <td>${escapeHtml(u.role)}</td>
      <td class="small">${new Date(u.createdAt).toLocaleString()}</td>
      ${isAgent?`<td>${u.name!== (currentUser?.name||'') ? `<button class="mute-btn" onclick="toggleMute(${i})">${u.muted? 'إلغاء المنع' : 'منع من الدردشة'}</button> <button class="delete-btn" onclick="deleteUser(${i})">حذف</button>` : '-'}</td>` : ''}
    </tr>`;
  });
  html += `</tbody></table>`;
  el.innerHTML = html;
}

/* ===== حظر/إلغاء حظر عضو ===== */
function toggleMute(index){
  // تحقق صلاحية الوكيل
  if (!currentUser || currentUser.role !== 'وكيل') { alert('❌ فقط الوكيل يمكنه منع الأعضاء.'); return; }
  users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  users[index].muted = !users[index].muted;
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  renderUsers();
  alert(users[index].muted ? '🚫 تم منع العضو من الدردشة' : '✅ تم السماح له مجددًا');
}

/* ===== حذف عضو (وكيل فقط) ===== */
function deleteUser(index){
  if (!currentUser || currentUser.role !== 'وكيل') return alert('❌ فقط الوكيل يمكنه حذف الأعضاء.');
  if (!confirm('هل أنت متأكد من حذف هذا العضو؟')) return;
  users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  const removed = users.splice(index,1)[0];
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  // إذا حذف الوكيل نفسه (غير متوقع) أزل currentUser
  if (currentUser && currentUser.name === removed.name) {
    localStorage.removeItem(CURRENT_KEY);
    currentUser = null;
    updateChatButton();
  }
  renderUsers();
  alert('🗑️ تم حذف العضو.');
}

/* ===== الدردشة: إرسال/عرض ورسائل محفوظة ===== */
function sendMessage(){
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  if (!currentUser) { alert('يجب التسجيل أولاً للدخول إلى الدردشة.'); return; }
  // منع إذا كان المستخدم ممنوعًا
  // ولكنه يجب أن يقرن حالة المستخدم الحالية من users array لأن currentUser قديم
  const latestUsers = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  const me = latestUsers.find(u=>u.name === currentUser.name) || currentUser;
  if (me.muted) return alert('🚫 تم منعك من إرسال الرسائل.');
  const msg = { user: me.name, role: me.role, text, time: new Date().toISOString() };
  messages.push(msg);
  localStorage.setItem(MESSAGES_KEY, JSON.stringify(messages));
  input.value = '';
  renderMessages();
}

/* ===== عرض الرسائل ===== */
function renderMessages(){
  const box = document.getElementById('messages');
  messages = JSON.parse(localStorage.getItem(MESSAGES_KEY)) || [];
  if (messages.length === 0) { box.innerHTML = '<p class="small center">لا توجد رسائل بعد.</p>'; return; }
  box.innerHTML = messages.map(m=>{
    const mark = m.role === 'وكيل' ? ' (وكيل)' : '';
    return `<div class="message"><div class="meta">${escapeHtml(m.user)}${mark} <span class="small">— ${new Date(m.time).toLocaleString()}</span></div><div>${escapeHtml(m.text)}</div></div>`;
  }).join('');
  box.scrollTop = box.scrollHeight;
}

/* ===== عرض صفحة الدردشة وإظهار أدوات الوكيل فقط له ===== */
/* ===== عرض صفحة الدردشة (مرئية للجميع) ===== */
function renderChat(){
  const tools = document.getElementById('agentTools');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.querySelector('.chat-box button');

  // الوكيل فقط يرى أدوات الإدارة
  if (currentUser && currentUser.role === 'وكيل') {
    tools.classList.remove('hidden');
  } else {
    tools.classList.add('hidden');
  }

  // أي شخص يمكنه رؤية الرسائل
  renderMessages();

  // السماح بالكتابة فقط للمسجلين
  if (!currentUser) {
    chatInput.disabled = true;
    chatInput.placeholder = "📢 الدردشة عامة — سجّل لتستطيع الكتابة";
    sendBtn.disabled = true;
    sendBtn.style.opacity = "0.6";
    sendBtn.style.cursor = "not-allowed";
  } else {
    chatInput.disabled = false;
    chatInput.placeholder = "اكتب رسالتك ثم اضغط Enter";
    sendBtn.disabled = false;
    sendBtn.style.opacity = "1";
    sendBtn.style.cursor = "pointer";
  }
}

/* ===== مسح الدردشة (وكيل فقط) ===== */
function clearChat(){
  if (!currentUser || currentUser.role !== 'وكيل') return alert('❌ فقط الوكيل يمكنه مسح الدردشة.');
  if (!confirm('هل تريد مسح جميع الرسائل؟')) return;
  messages = [];
  localStorage.setItem(MESSAGES_KEY, JSON.stringify(messages));
  renderMessages();
  alert('🧹 تم مسح الدردشة بنجاح.');
}

/* ===== دالة تعقيم النص قبل الإدراج في HTML ===== */
function escapeHtml(str){ return String(str || '').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

/* ===== إشعار الوكيل عند تسجيل عضو جديد (محلي وتبويبي) ===== */
function notifyAgentNewUser(newUser){
  // إذا الوكيل مسجل حاليًا في هذا التاب وأنت لست الوكيل الذي سجل (أو حتى لو هو)، نظهر تنبيه
  // سنراقب أيضاً عبر حدث storage للتبويبات الأخرى.
  if (currentUser && currentUser.role === 'وكيل' && currentUser.name !== newUser.name) {
    alert(`🔔 انضم عضو جديد: ${newUser.name} — ${newUser.role}`);
  }
  // حدث التخزين (localStorage) سيخبر التبويبات الأخرى لأننا حفظنا users بالفعل.
}

/* ===== مراقبة تغيّر localStorage لإشعارات التبويبات الأخرى ===== */
window.addEventListener('storage', (e) => {
  if (e.key === USERS_KEY) {
    // تم تغيير قائمة الأعضاء في تبويب آخر
    // حدّث الذاكرة المحلية لدينا
    users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
    // إذا المستخدم الحالي هو الوكيل، ونشاهد أن عدد الأعضاء ازداد، ننبّه
    if (currentUser && currentUser.role === 'وكيل') {
      // التفصيل: يمكن مقارنة الأطوال أو البحث عن أحدث عنصر جديد
      // سنبقيها بسيطة: نخبر الوكيل أن هناك تحديث
      alert('🔔 تم تحديث قائمة الأعضاء — تحقق من صفحة الأعضاء.');
    }
  }
  if (e.key === MESSAGES_KEY) {
    // رسائل جديدة في تبويب آخر — حدّث العرض إن كنا في صفحة الدردشة
    messages = JSON.parse(localStorage.getItem(MESSAGES_KEY)) || [];
    // إذا صفحة الدردشة مفتوحة — حدث الرسائل
    if (document.querySelector('#chat')?.classList.contains('active')) renderMessages();
  }
});

/* ===== عند تحميل التطبيق (بعد القفل والسلاش) ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  // تحميل حالة أولية
  users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY)) || null;
  messages = JSON.parse(localStorage.getItem(MESSAGES_KEY)) || [];
  // ضع استماع للـ زر الدخول عبر لوحة المفاتيح (Enter)
  document.getElementById('accessCode').addEventListener('keydown', (e)=>{ if(e.key==='Enter') lockBtn.click(); });
  // زر إرسـال رسالة Enter
  document.getElementById('chatInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });
  // إعداد زر القفل
  unlockFlow();
});

/* ===== مساعدة: اجعل صفحة الأعضاء تحدث تلقائياً عند التسجيل الحالي ===== */
/* (لو تريد أن يعرض فورًا بعد التسجيل دون فتح صفحة الأعضاء) — سنقوم بذلك بعد التسجيل عبر showSection('users') إن رغبت */
/* لكن حالياً بعد التسجيل نعرض welcome فقط؛ يمكن للوكيل التحقق من الأعضاء بالضغط على الأعضاء. */

</script>
</body>
</html>

